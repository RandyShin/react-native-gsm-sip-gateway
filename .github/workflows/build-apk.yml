name: Build Gateway (Final Path & Link Fix)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Main App
        uses: actions/checkout@v4

      - name: Force HTTPS for Git
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://".insteadOf ssh://

      # 1. 앱이 기대하는 상대 경로(..)에 맞게 라이브러리 클론
      - name: Clone Peer Modules
        run: |
          git clone https://github.com/telon-org/react-native-tele.git
          git clone https://github.com/telon-org/react-native-sip2.git
          git clone https://github.com/telon-org/react-native-replace-dialer.git
          ls -d */ # 폴더 생성 확인

      - name: Setup Environment
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 2. 의존성 강제 설치 및 누락 파일 체크
      - name: Install Dependencies
        run: |
          cd telon-gateway-app
          npm install -g yarn
          # 캐시 없이 깨끗하게 설치 (네트워크 타임아웃 방지)
          yarn install --network-timeout 600000
          
          # [핵심] 만약 파일이 없으면 수동으로 설치 확인
          if [ ! -f node_modules/@react-native-community/cli-platform-android/native_modules.gradle ]; then
            echo "::warning::File missing! Retrying specific CLI install..."
            npm install @react-native-community/cli-platform-android --legacy-peer-deps
          fi
          
          # 설치 결과 출력 (디버깅용)
          find node_modules -name "native_modules.gradle"

      # 3. Android 빌드 실행
      - name: Build APK
        run: |
          cd telon-gateway-app/android
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace
